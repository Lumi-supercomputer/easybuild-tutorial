
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://klust.github.io/easybuild-tutorial/2022-CSC_and_LO/1_Intro/1_02_Lmod/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>The Lmod module system - EasyBuild tutorial</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-lmod-module-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EasyBuild tutorial" class="md-header__button md-logo" aria-label="EasyBuild tutorial" data-md-component="logo">
      
  <img src="../../../img/easybuild_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EasyBuild tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              The Lmod module system
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/klust/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    EasyBuild @ GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EasyBuild tutorial" class="md-nav__button md-logo" aria-label="EasyBuild tutorial" data-md-component="logo">
      
  <img src="../../../img/easybuild_logo.png" alt="logo">

    </a>
    EasyBuild tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/klust/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    EasyBuild @ GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">CSC (spring '22)</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="CSC (spring '22)" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          CSC (spring '22)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Introduction to EasyBuild</a>
          
            <label for="__nav_2_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Introduction to EasyBuild" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Introduction to EasyBuild
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_01_what_is_easybuild/" class="md-nav__link">
        What is EasyBuild?
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          The Lmod module system
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        The Lmod module system
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules" class="md-nav__link">
    Modules
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmod-hierarchy" class="md-nav__link">
    Lmod hierarchy
  </a>
  
    <nav class="md-nav" aria-label="Lmod hierarchy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-view" class="md-nav__link">
    User view
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-blocks" class="md-nav__link">
    Building blocks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    Implementation details
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finding-modules" class="md-nav__link">
    Finding modules
  </a>
  
    <nav class="md-nav" aria-label="Finding modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-spider-command" class="md-nav__link">
    module spider command
  </a>
  
    <nav class="md-nav" aria-label="module spider command">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-extensions" class="md-nav__link">
    Module extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-keyword" class="md-nav__link">
    module keyword
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-avail" class="md-nav__link">
    module avail
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-help" class="md-nav__link">
    Getting help
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_1" class="md-nav__link">
    Implementation details
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-warnings-about-writing-modulefiles" class="md-nav__link">
    Some warnings about writing modulefiles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further reading
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_03_CPE/" class="md-nav__link">
        The HPE Cray Programming Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_04_LUMI_software_stack/" class="md-nav__link">
        LUMI software stacks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_05_terminology/" class="md-nav__link">
        Terminology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_06_installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_07_configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_08_basic_usage/" class="md-nav__link">
        Basic usage
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../2_Using/">Using EasyBuild</a>
          
            <label for="__nav_2_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Using EasyBuild" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Using EasyBuild
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2_Using/2_01_troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2_Using/2_02_creating_easyconfig_files/" class="md-nav__link">
        Creating easyconfig files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2_Using/2_03_external_modules/" class="md-nav__link">
        Using external modules from the Cray PE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2_Using/2_04_implementing_easyblocks/" class="md-nav__link">
        Implementing easyblocks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../3_Advanced/">Advanced topics</a>
          
            <label for="__nav_2_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Advanced topics" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Advanced topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3_Advanced/3_01_easybuild_library/" class="md-nav__link">
        Using EasyBuild as a library
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3_Advanced/3_02_hooks/" class="md-nav__link">
        Using hooks to customise EasyBuild
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3_Advanced/3_03_slurm_jobs/" class="md-nav__link">
        Submitting installations as Slurm jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3_Advanced/3_04_module_naming_schemes/" class="md-nav__link">
        Module naming schemes (incl. hierarchical)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3_Advanced/3_05_github_integration/" class="md-nav__link">
        GitHub integration to facilitate contributing to EasyBuild
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4_00_additional_reading/" class="md-nav__link">
        Additional reading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Archive
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Archive" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Archive
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../2020-06-isc20/">ISC'20 (June '20)</a>
          
            <label for="__nav_3_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="ISC'20 (June '20)" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          ISC'20 (June '20)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/practical_information/" class="md-nav__link">
        Practical information
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/basic_usage/" class="md-nav__link">
        Basic usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/hmns/" class="md-nav__link">
        Hierarchical module naming schemes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/adding_support_software/" class="md-nav__link">
        Adding support for additional software
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/jsc/" class="md-nav__link">
        EasyBuild at JÃ¼lich Supercomputing Centre
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/computecanada/" class="md-nav__link">
        EasyBuild at Compute Canada
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/community/" class="md-nav__link">
        The EasyBuild community
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/contributing/" class="md-nav__link">
        Contributing to EasyBuild
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/comparison_other_tools/" class="md-nav__link">
        Comparison with other tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020-06-isc20/getting_help/" class="md-nav__link">
        Getting help
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../2021-lust/">LUST (spring '21)</a>
          
            <label for="__nav_3_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="LUST (spring '21)" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          LUST (spring '21)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_2" type="checkbox" id="__nav_3_2_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_2">
          Introduction to EasyBuild
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Introduction to EasyBuild" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_2">
          <span class="md-nav__icon md-icon"></span>
          Introduction to EasyBuild
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/part1_intro/" class="md-nav__link">
        (overview)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/what_is_easybuild/" class="md-nav__link">
        What is EasyBuild?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/terminology/" class="md-nav__link">
        Terminology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/basic_usage/" class="md-nav__link">
        Basic usage
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3" type="checkbox" id="__nav_3_2_3" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_3">
          Using EasyBuild
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Using EasyBuild" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_3">
          <span class="md-nav__icon md-icon"></span>
          Using EasyBuild
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/part2_using/" class="md-nav__link">
        (overview)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/creating_easyconfig_files/" class="md-nav__link">
        Creating easyconfig files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/implementing_easyblocks/" class="md-nav__link">
        Implementing easyblocks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_4" type="checkbox" id="__nav_3_2_4" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_4">
          Advanced topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Advanced topics" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_4">
          <span class="md-nav__icon md-icon"></span>
          Advanced topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/part3_advanced/" class="md-nav__link">
        (overview)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/easybuild_library/" class="md-nav__link">
        Using EasyBuild as a library
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/hooks/" class="md-nav__link">
        Using hooks to customise EasyBuild
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/slurm_jobs/" class="md-nav__link">
        Submitting installations as Slurm jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/module_naming_schemes/" class="md-nav__link">
        Module naming schemes (incl. hierarchical)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/github_integration/" class="md-nav__link">
        GitHub integration to facilitate contributing to EasyBuild
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_5" type="checkbox" id="__nav_3_2_5" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_5">
          EasyBuild on Cray systems
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="EasyBuild on Cray systems" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_5">
          <span class="md-nav__icon md-icon"></span>
          EasyBuild on Cray systems
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/part4_cray/" class="md-nav__link">
        (overview)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/cray/introduction/" class="md-nav__link">
        Introduction to the Cray PE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/cray/external_modules/" class="md-nav__link">
        Using external modules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/cray/custom_toolchains/" class="md-nav__link">
        Custom Cray toolchains
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-lust/cray/easybuild_at_cscs/" class="md-nav__link">
        EasyBuild at CSCS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../2021-isc21/">ISC'21 (25 June 2021)</a>
          
            <label for="__nav_3_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="ISC'21 (25 June 2021)" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          ISC'21 (25 June 2021)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/practical_info/" class="md-nav__link">
        Practical info
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/terminology/" class="md-nav__link">
        Terminology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/basic_usage/" class="md-nav__link">
        Basic usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/installing_software/" class="md-nav__link">
        Installing software
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/module_naming_schemes/" class="md-nav__link">
        Module naming schemes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/adding_support_additional_software/" class="md-nav__link">
        Support for additional software
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/jsc/" class="md-nav__link">
        EasyBuild at JSC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/computecanada/" class="md-nav__link">
        EasyBuild at Compute Canada
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/community/" class="md-nav__link">
        The EasyBuild community
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2021-isc21/contributing/" class="md-nav__link">
        Contributing to EasyBuild
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules" class="md-nav__link">
    Modules
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lmod-hierarchy" class="md-nav__link">
    Lmod hierarchy
  </a>
  
    <nav class="md-nav" aria-label="Lmod hierarchy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-view" class="md-nav__link">
    User view
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-blocks" class="md-nav__link">
    Building blocks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    Implementation details
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finding-modules" class="md-nav__link">
    Finding modules
  </a>
  
    <nav class="md-nav" aria-label="Finding modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-spider-command" class="md-nav__link">
    module spider command
  </a>
  
    <nav class="md-nav" aria-label="module spider command">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-extensions" class="md-nav__link">
    Module extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-keyword" class="md-nav__link">
    module keyword
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-avail" class="md-nav__link">
    module avail
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-help" class="md-nav__link">
    Getting help
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_1" class="md-nav__link">
    Implementation details
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-warnings-about-writing-modulefiles" class="md-nav__link">
    Some warnings about writing modulefiles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further reading
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/klust/easybuild-tutorial/edit/master/docs/2022-CSC_and_LO/1_Intro/1_02_Lmod.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>



<h1 id="the-lmod-module-system">The Lmod module system<a class="headerlink" href="#the-lmod-module-system" title="Permanent link">&para;</a></h1>
<p><em><a href="../1_01_what_is_easybuild/">[back: What is EasyBuild?]</a></em></p>
<hr />
<h2 id="modules">Modules<a class="headerlink" href="#modules" title="Permanent link">&para;</a></h2>
<p><em>Module</em> is a massively overloaded term in (scientific) software and IT in general
(kernel modules, Python modules, and so on).
In the context of EasyBuild, the term 'module' usually refers to an <strong>environment module (file)</strong>.</p>
<p><a href="https://en.wikipedia.org/wiki/Environment_Modules_(software)">Environment modules</a> is a well established concept
on HPC systems: it is a way to specify changes that should be made to one or more
<a href="https://en.wikipedia.org/wiki/Environment_variable">environment variables</a> in a
<a href="https://en.wikipedia.org/wiki/Shell_(computing)">shell</a>-agnostic way. A module file
is usually written in either <a href="https://en.wikipedia.org/wiki/Tcl">Tcl</a> or
<a href="https://en.wikipedia.org/wiki/Lua_(programming_language)">Lua</a> syntax,
and specifies which environment variables should be updated, and how (append,
prepend, (re)define, undefine, etc.) upon loading the environment module.
Unloading the environment module will restore the shell environment to its previous state.</p>
<p>Environment module files are processed via a <strong>modules tool</strong>, of which there
are several conceptually similar yet slightly different implementations.
The oldest module tool still in use today is Environment Modules 3.2, implemented in C and 
supporting module files written in Tcl. After a gap in developement, Xavier Delaruelle of CEA
developed <a href="https://sourceforge.net/projects/modules/">Environment Modules 4 and 5</a> which is
fully implemented on Tcl. An alternative module tool is <a href="https://lmod.readthedocs.io">Lmod</a>, 
developed by Robert McLay at TACC and implemented in LUA. This tool supports natively LUA
module files but also offers a high degree of compatibility with Tcl-based module files
developed for Environment Modules fia a translation layer and some API translation.</p>
<p>The Cray PE offers a choice between the old-style Environment Modules 3.2 and Lmod, but no
packages or official support for Environment Modules 4 or 5. At the user level, 
Environment Modules 3.2 and Lmod have many commands in common, but with different options. 
Lmod also has some powerful features that are lacking in Environment Modules 3.2.</p>
<div class="admonition note">
<p class="admonition-title">The Cray PE on LUMI</p>
<p>On LUMI, Lmod was selected as the module tool. One area where there are significant
differences between Environment Modules 3.2 (and also the newer versions) and Lmod is
in the commands for discovering modules on the system. If you are not familiar with Lmod 
and its commands for users, it is worthwile to read the 
<a href="https://docs.lumi-supercomputer.eu/computing/Lmod_modules/">LUMI documentation page on Lmod</a>.
Some of those commands are also discussed on this page.</p>
</div>
<hr />
<h2 id="lmod-hierarchy">Lmod hierarchy<a class="headerlink" href="#lmod-hierarchy" title="Permanent link">&para;</a></h2>
<h3 id="user-view">User view<a class="headerlink" href="#user-view" title="Permanent link">&para;</a></h3>
<p>Lmod supports a module hierarchy. In a hierarchy, there is a distinction between the <em>installed
modules</em> and the <em>available modules</em>. Available modules are those that can be loaded directly 
without first loading any other module, while the installed modules is the complete set of 
modules that one could load one way or another. A typical use case
is a hierarchy to deal with different compilers on a system and different MPI implementations.
After all, it is a common practice to only link libraries and application code compiled with the
same compiler to avoid compatibility problems between compilers (and to be able to use advanced
features such as link time optimization). This is even more important for MPI, as Open MPI and 
MPCIH-derived MPI implementations have incompatible Application Binary Interfaces. This would lead
to a hierarchy with 3 levels:</p>
<ol>
<li>
<p>The <code>Core</code> level containing the modules for the compilers themselves, e.g., one or more versions
    of the GNU compiler suite and one or more versions of LLVM-based compilers.</p>
<p>Loading a compiler module would then make the next level available:</p>
</li>
<li>
<p>The <code>Compiler</code> level, containing modules for libraries and packages that only rely on the compilers
    but do not use MPI, as well as the MPI modules, e.g., a version of Open MPI and a version of MPICH.</p>
<p>Loading one of the MPI modules would then make the next level available:</p>
</li>
<li>
<p>The <code>MPI</code> level, containing libraries and applications that depend on the compiler used and the MPI
    implementation.</p>
</li>
</ol>
<details class="example">
<summary>A simple Lmod hierarchy with a single compiler</summary>
<p>Here is a simple example of such a 3-level module hierarchy
(that almost could have been generated by EasyBuild):</p>
<p><div align="center"><img src="../../img/hmns.png" width="60%"/></div></p>
<p>In this example the <code>Core</code> level only includes a single module <code>GCC/9.3.0</code>,
while  the <code>Compiler</code> level includes two modules: <code>OpenMPI/4.0.3</code> and <code>MPICH/3.3.2</code>.
In the <code>MPI</code> level, three modules are available: one for <code>FFTW</code>, one for <code>ScaLAPACK</code>, 
and one for <code>HDF5</code>.</p>
<p>Initially only the modules on the top level of a module hierarchy are available for loading.
If you run "<code>module avail</code>", the command that is used to view all modules that are available
for loading, with this example module hierarchy, you will only see the <code>GCC/9.3.0</code> module.</p>
<p>Some modules in the top level of the hierarchy act as a "gateway" to modules in the
next level below.
To make additional modules available for loading one of these gateway modules has to be loaded. 
In our example, loading the <code>GCC/9.3.0</code> module results in two additional modules coming into
view from the <code>Compiler</code> level, as indicated by the arrows: the modules for <code>OpenMPI</code> and <code>MPICH</code>. 
These correspond to installations of <code>OpenMPI</code>
and <code>MPICH</code> that were built using <code>GCC/9.3.0</code>.</p>
<p>Similarly, the <code>OpenMPI/4.0.3</code> module serves as a gateway to the three modules in the <code>MPI</code> level. 
Only by loading the <code>OpenMPI</code> module will these additional three modules become
available for loading. They correspond to software installations built using the <code>GCC/9.3.0</code>
compiler with <code>OpenMPI/4.0.3</code>. </p>
</details>
<p>Now assume that we have two compilers in the hierarchy, Compiler_A and Compiler_B. Their modules would reside
at the <code>Core</code> level. Both compilers provide the same MPI implementation, MPI_C. So there would be two modules
for <code>MPI_C</code> in two different subdirectories at the <code>Compiler</code> level. And further assume that we have an
application, Appl_E, compiled with both Compiler_A and Compiler_B and using MPI_C. For that application there would
also be two module files at the <code>MPI</code> level,  one in a subdirectory corresponding ao Compiler_A and MPI_C and one
in a subdirectory corresponding to Compiler_B and MPI_C. </p>
<pre class="mermaid"><code>graph TD;
A[Compiler_A] --&gt; AC[MPI_C];
A --&gt; AD[MPI_D]
B[Compiler_B] --&gt; BC[MPI_C];
AC --&gt; ACE[Appl_E];
AD --&gt; ADE[Appl_E]
BC --&gt; BCE[Appl_E];</code></pre>
<p>To be able to load the module for Appl_E, a user should
first load Compiler_A, then load MPI_C and only then is it possible to load the module for Appl_E:</p>
<div class="highlight"><pre><span></span><code>module load Compiler_A MPI_C Appl_E
</code></pre></div>
<p>What is interesting is what happens if the user now loads Compiler_B:</p>
<div class="highlight"><pre><span></span><code>module load Compiler_B
</code></pre></div>
<p>In a properly designed and implemented hierarchy, Lmod will unload Compiler_A which will also trigger the unloading/deactivation
of MPI_C and Appl_E. It will then load the module for Compiler_B and proceed with looking if it can find another module for
MPI_C. That will then be loaded which now makes a different module for Appl_E available, which Lmod will proceed to load. If it
cannot find an exact match for the version, Lmod will even try to locate a different version. Hence the situation after loading 
Compiler_B is that now modules are loaded for Compiler_B, MPI_C for Compiler_B and Appl_E for Compiler_A with MPI_C.
All this requires very little effort from the module file programmer and very little logic in the module files. E.g., rather
then implementing a single module file for Appl_E that would require logic to see which compiler and MPI implementation is loaded
and depending on those adapt the path to the binaries, several very simple modules need to be written with very little 
logic, and one could add an Appl_E module for a different compiler or MPI implementation without touching any of the already
existing module files for that application.</p>
<p>Similarly, if after</p>
<div class="highlight"><pre><span></span><code>module load Compiler_A MPI_C Appl_E
</code></pre></div>
<p>one does </p>
<div class="highlight"><pre><span></span><code>module load MPI_D
</code></pre></div>
<p>thent MPI_C gets unloaded, Lmod notices that it also has to unload/deactivate Appl_E, then will load MPI_D for Compiler_A and
finally will notice that there is an equivalent Appl_E module available again, and Lmod will load that one also. However,
now loading Compiler_B will cause a warning that MPI_D and Appl_E have been deactivated as there is no module name MPI_D in
any version for Compiler_B.</p>
<h3 id="building-blocks">Building blocks<a class="headerlink" href="#building-blocks" title="Permanent link">&para;</a></h3>
<p>Some mechanisms in Lmod make implementing a hierarchy fairly easy (though there are a lot of hidden pitfalls)</p>
<ul>
<li>
<p>The <em>MODULEPATH</em> environment variable determines which modules are available. MODULEPATH is different from any other 
    path-style variable in Lmod in that any change will immediately trigger a re-evaluation of which modules are available
    and trigger deactivating modules that are no longer available when a directory is removed from the MODULEPATH or
    looking for alternatives for deactivated modules when a directory is added to the MODULEPATH.</p>
</li>
<li>
<p>The <em>"one name rule"</em>: Lmod cannot have two modules loaded with the same name (but a different version). By default, when loading
    a module with the name of an already loaded module, Lmod will automatically swap the old one with the new one, i.e., unload the
    already loaded module and load the new one. </p>
</li>
<li>
<p>The <em>family</em> concept: It is possible to declare a module to be part of a family using a command in the module file. No two modules
    of the same family can be loaded at the same time, and Lmod will again by default auto-swap the already loaded one with the one
    being loaded. The procedure is different though as Lmod now first has to read the new module file to discover the family, and this
    may lead to more side effects. But that discussion is outside the scope of this tutorial.</p>
<p>The family concept was for a long time a unique feature of Lmod, but it has been added now also to Environment Modules version 5.1.</p>
</li>
</ul>
<h3 id="implementation-details">Implementation details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h3>
<p>The above example could be implemented using 8 module files: One for each compiler, three for the MPI modules
(two for MPI_C and one for MPI_D) and 
three for the application modules.</p>
<div class="highlight"><pre><span></span><code>moduleroot
âââ Core
â   âââ Compiler_A
â   â   âââ version_A.lua
â   âââ Compiler_B
â       âââ version_B.lua
âââ Compiler
â   âââ Compiler_A
â   â   âââ version_A
â   â       âââ MPI_C
â   â       â   âââ version_C.lua
â   â       âââ MPI_D
â   â           âââ version_D.lua
â   âââ Compiler_B
â       âââ version_B
â           âââ MPI_C
â               âââ version_C.lua
âââ MPI
    âââ Compiler_A
    â   âââ version_A
    â       âââ MPI_C
    â       â   âââ version_C
    â       â       âââ Appl_E
    â       â           âââ version_E.lua
    â       âââ MPI_D
    â           âââ version_D
    â               âââ Appl_E
    â                   âââ version_E.lua
    âââ Compiler_B
        âââ version_B
            âââ MPI_C
                âââ version_C
                    âââ Appl_E
                        âââ version_E.lua
</code></pre></div>
<p>Besides the module functions needed to create the environment needed to run the compiler, the module file for
Compiler_A would need only two lines to implement the hierarchy:</p>
<div class="highlight"><pre><span></span><code><span class="n">family</span><span class="p">(</span><span class="s1">&#39;Compiler&#39;</span><span class="p">)</span>
<span class="n">prepend_path</span><span class="p">(</span><span class="s1">&#39;MODULEPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;moduleroot/Compiler/Compiler_A/version_A&#39;</span><span class="p">)</span>
</code></pre></div>
<p>There are now two different <code>version_C.lua</code> files. One contains the necessary calls to module functions to
initialise the environment to use the version compiled with Compiler_A/version_A while the other contains the
necessary functions to do that for Compiler_B/version_B. Again, two more lines are needed to implement the hierarchy.
E.g., for <code>moduleroot/Compiler/Compiler_A/version_A/MPI_C/version_C.lua</code>: </p>
<div class="highlight"><pre><span></span><code><span class="n">family</span><span class="p">(</span><span class="s1">&#39;MPI&#39;</span><span class="p">)</span>
<span class="n">prepend_path</span><span class="p">(</span><span class="s1">&#39;MODULEPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;moduleroot/MPI/Compiler_A/version_A/MPI_C/version_C&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Finally two vesions of the <code>version_E.lua</code> file are needed, one to prepare the environment for using the 
package with Compiler_A anmd MPI_C and one for using the package with Compiler_B and MPI_C. However, these
are just regular modules and no additions are needed to work for the hierarchy.</p>
<p>Both EasyBuild and Spack support Lmod hierarchies and with these tools it is also fairly automatic to create
different versions of the module files for each compiler and MPI library used to build the application. When
hand-writing modules it may be more interesting to have a generic module which would work for all those cases
and that is also possible with Lmod. Lmod does have a range of <em>introspection functions</em> that a module can use 
to figure out its name, version and place in the module tree. All that would be needed is that the various
instances of the module file are at the correct location in the module tree and link to the generic file which
can be outside the module tree. In fact, this feature is used on LUMI to implement the modules that load a
particular version of the hardware for a particular section of LUMI.</p>
<hr />
<h2 id="finding-modules">Finding modules<a class="headerlink" href="#finding-modules" title="Permanent link">&para;</a></h2>
<p>In a hierarchical setup, not all modules are available at login. This implies that a user cannot use
<code>module avail</code> to discover which software is available on the system. To this end Lmod has powerful
search commands. It is important to understand how these commands work to ensure that the proper information
is included in the module files to improve discoverability of software.</p>
<div class="admonition note">
<p class="admonition-title">Documentation in the LUMI documentation</p>
<p>Extensive information on search commands with examples of how to use them on LUMI can be found
in the <a href="[https://">LUMI documentation</a>](https://docs.lumi-supercomputer.eu/), in
<a href="https://docs.lumi-supercomputer.eu/computing/Lmod_modules/#finding-modules">the computing section, "Module environment page", "Finding modules" section</a>.</p>
</div>
<h3 id="module-spider-command">module spider command<a class="headerlink" href="#module-spider-command" title="Permanent link">&para;</a></h3>
<p>The available modules at any point in time are often only a subset of all installed modules on a
system. However, Lmod provides the <code>module spider</code> command to search for a module with a given name 
among all installed modules and to tell you how this module can be loaded (i.e., which other modules
need to be loaded to make the module available).</p>
<p>The <code>module spider</code> command has three levels, producing different outputs:</p>
<ol>
<li>
<p><code>module spider</code> without further arguments will produce a list of all
    installed software and show some basic information about those packages.
    Some packages may have an <code>(E)</code> behind their name and will appear in blue
    (in the default colour scheme) which means that they are part of a different
    package. These are called <em>extensions</em>  of packages or modules.
    This is explained a little further in this page.</p>
<p>Note that <code>module spider</code> will also search in packages that are hidden from
being displayed. These packages can be loaded and used. However administrators
may have decided to hide them
either because they are not useful to regular users or because they think that
they will rarely or never be directly loaded by a user and want to avoid
overloading the module display.</p>
</li>
<li>
<p><code>module spider &lt;name of package&gt;</code> will search for the specific package. This
    can be the name of a module, but it will also search some other information
    that can be included in the modules. The search is also case-insensitive.
    E.g., on LUMI
    <div class="highlight"><pre><span></span><code>module spider GNUplot
</code></pre></div>
    will show something along the lines of
    <div class="highlight"><pre><span></span><code>------------------------------------------------------------------
  gnuplot:
------------------------------------------------------------------
    Description:
      Gnuplot is a portable command-line driven graphing utility

     Versions:
        gnuplot/5.4.2-cpeCray-21.08
        gnuplot/5.4.2-cpeGNU-21.08
</code></pre></div>
    so even though the capitalisation of the name was wrong, it can tell us that
    there are two versions of gnuplot. The <code>cpeGNU-21.08</code> and <code>cpeCray-21.08</code>
    tell that the difference is the compiler that was used to install gnuplot,
    being the GNU compiler (PrgEnv-gnu) and the Cray compiler (PrgEnv-cray)
    respectively.</p>
<p>In some cases, if there is no ambiguity, <code>module spider</code> will actually
already produce help about the package, which is the next level.</p>
</li>
<li>
<p><code>module spider &lt;module name&gt;/&lt;version&gt;</code> will show more help information
     about the package, including information on which other modules need to be
     loaded to be able to load the package. E.g., 
     <div class="highlight"><pre><span></span><code>module spider git/2.35.1
</code></pre></div>
     will return something along the lines of
     <div class="highlight"><pre><span></span><code>-------------------------------------------------------------------
  git: git/2.35.1
-------------------------------------------------------------------
   Description:
     Git is a free and open source distributed version control
     system

   You will need to load all module(s) on any one of the lines below
   before the &quot;git/2.35.1&quot; module is available to load.

     CrayEnv
     LUMI/21.12  partition/C
     LUMI/21.12  partition/D
     LUMI/21.12  partition/G
     LUMI/21.12  partition/L

   Help:
</code></pre></div>
     (abbreviated output). Note that it also tells you which other modules need
     to be loaded. You need to choose the line which is appropriate for you and
     load all modules on that line, not the whole list of in this case 9
     modules.</p>
</li>
</ol>
<div class="admonition failure">
<p class="admonition-title">Known issue</p>
<p>The Cray PE uses Lmod in an unconventional manner with the hierarchy not
build fully in the way Lmod expects. As a consequence Lmod is not always
able to generate the correct list of modules that need to be loaded to make
a package available, and the list of ways to make a module available may 
also be incomplete.</p>
<p>The problem is somewhat aggrevated on LUMI because the Cray PE hierarchy sits
next to the hierarchy of the software stack as the Cray PE is installed 
separately and hence cannot be integrated in the way the Lmod developer had
in mind.</p>
</div>
<h4 id="module-extensions">Module extensions<a class="headerlink" href="#module-extensions" title="Permanent link">&para;</a></h4>
<p>Certain packages, e.g., Python, Perl or R, get a lot of their functionality through 
other packages that are installed together with them and extend the functionity, 
e.g., NumPy and SciPy for Python. Installing all those packages as separate modules
to make it easy to see if they are installed or not on a system would lead to an
overload of modules on the system. </p>
<p>Similary, admins of a software stack may chose to bundle several libraries or tools
that are often used together in a single module (and single installation directory),
e.g., to reduce module clutter but also to reduce the length of the search paths for
binaries, libraries or manual pages to speed up loading of applications.</p>
<p>Lmod offers a way to make those individual packages installed in a module discoverable
by declaring them as <em>extensions</em> of the module. The <code>module spider</code> command will
search for those too.</p>
<ol>
<li>
<p><code>module spider</code> without further arguments: The output may contain lines similar
    to
    <div class="highlight"><pre><span></span><code>-----------------------------------------------------------------------
The following is a list of the modules and extensions currently available:
-----------------------------------------------------------------------
  Autoconf: Autoconf/2.71 (E)

  CMake: CMake/3.21.2 (E), CMake/3.22.2 (E)
</code></pre></div>
    which tells that <code>Autoconf</code> and <code>CMake</code> are not available as modules themselves
    but as extensions of another module, and it also tells the versions that are available,
    though that list may not be complete (and is not always complete for modules either
    as it is limited to one line of output).</p>
</li>
<li>
<p><code>module spider &lt;name of package&gt;</code> will search for extensions also. E.g.,
    <div class="highlight"><pre><span></span><code>module spider CMake
</code></pre></div>
    on LUMI will return something along the lines of
    <div class="highlight"><pre><span></span><code>-----------------------------------------------------------------------
  CMake:
-----------------------------------------------------------------------
     Versions:
        CMake/3.21.2 (E)
        CMake/3.22.2 (E)
</code></pre></div>
    (output abbreviated). 
    This tells that there is no <code>CMake</code> module on the system but that two versions
    of <code>CMake</code> are provided in another module.</p>
</li>
<li>
<p><code>module spider &lt;extension name&gt;/&lt;version&gt;</code> will show more information on the
     extension, including which module provides the extension and which other modules
     have to be loaded to make that module available. E.g., on LUMI,
     <div class="highlight"><pre><span></span><code>module spider CMake/3.22.2
</code></pre></div>
     will output something along the lines of
     ```
     -----------------------------------------------------------------------
      CMake: CMake/3.22.2 (E)
    -----------------------------------------------------------------------
        This extension is provided by the following modules. To access the 
        extension you must load one of the following modules. Note that any 
        module names in parentheses show the module location in the software 
        hierarchy.</p>
<pre><code>   buildtools/21.12 (LUMI/21.12 partition/L)
   buildtools/21.12 (LUMI/21.12 partition/G)
   buildtools/21.12 (LUMI/21.12 partition/D)
   buildtools/21.12 (LUMI/21.12 partition/C)
   buildtools/21.12 (CrayEnv)
</code></pre>
<p><code>`
(output abbreviated and slightly reformatted for readability). This tells that</code>CMake/3.22.2<code>is provided by the</code>bvuildtools/21.12`` module and that there
are 5 different ways to make that package available.</p>
</li>
</ol>
<details class="bug">
<summary>Restrictions with older Lmod versions</summary>
<p>At the time of development of this tutorial, Cray is still using the pretty old
8.3.1 version of Lmod. Even though extensions were supported since Lmod version 8.2.5,
Lmod 8.3.1 has several problems:</p>
<ul>
<li>
<p>It is not possible to hide extensions in the output of <code>module avail</code>, a feature
    that only became available in version 8.5. This may be annoying to many users as
    the extension list of packages such as Python, R and Perl can be very long (the
    default EasyBuild installation of R contains on the order of 600 packages).</p>
<p>For that reason on LUMI extensions are only used for some modules.</p>
</li>
<li>
<p><code>module avail</code> also shows extensions for modules that are not available which
    makes no sense. This bug was only corrected in Lmod 8.6.13 and 8.6.14.</p>
</li>
</ul>
</details>
<h3 id="module-keyword">module keyword<a class="headerlink" href="#module-keyword" title="Permanent link">&para;</a></h3>
<p>Another search command that is sometimes useful is <code>module keyword</code>. It really
just searches for the given word in the short descriptions that are included in
most module files and in the name of the module. The output is not always
complete since not all modules may have a complete enough short description.</p>
<p>Consider we are looking for a library or package that supports MP3 audio
encoding.
<div class="highlight"><pre><span></span><code>module keyword mp3
</code></pre></div>
will return something along the lines of
<div class="highlight"><pre><span></span><code>----------------------------------------------------------------

The following modules match your search criteria: &quot;mp3&quot;
----------------------------------------------------------------

  LAME: LAME/3.100-cpeCray-21.08, LAME/3.100-cpeGNU-21.08
    LAME is a high quality MPEG Audio Layer III (mp3) encoder
</code></pre></div>
though the output will depend on the version of Lmod. This may not be the most
useful example on a supercomputer, but the library is in fact needed to be able
to install some other packages even though the sound function is not immediately
useful.</p>
<details class="bug">
<summary>Know issue: Irrelevant output</summary>
<p>At the moment of the development of this tutorial, this command actually
returns a lot more output, referring to completely irrelevant extensions.
This is a bug in the HPE-Cray-provided version of Lmod (8.3.1 at the time
of development of this tutorial) that was only solved in more recent versions.</p>
</details>
<h3 id="module-avail">module avail<a class="headerlink" href="#module-avail" title="Permanent link">&para;</a></h3>
<p>The <code>module avail</code> command is used to show only available modules, i.e., modules
that can be loaded directly without first loading other modules. It can be used
in two ways:</p>
<ol>
<li>
<p>Without a further argument it will show an often lengthy list of all
    available modules. Some modules will be marked with <code>(D)</code> which means that
    they are the default module that would be loaded should you load the module
    using only its name.</p>
</li>
<li>
<p>With the name of a module (or a part of the name) it will show all modules
    that match that (part of) a name. E.g.,
    <div class="highlight"><pre><span></span><code>module avail gnuplot
</code></pre></div>
    will show something along the lines of
    <div class="highlight"><pre><span></span><code>------ EasyBuild managed software for software stack LUMI/21.08 on LUMI-L ------
   gnuplot/5.4.2-cpeCray-21.08    gnuplot/5.4.2-cpeGNU-21.08 (D)

  Where:
   D:  Default Module
    (output abbreviated).
</code></pre></div>
    but
    <div class="highlight"><pre><span></span><code>module avail gnu
</code></pre></div>
    will show you an often lengthy list that contains all packages with gnu
    (case insensitive) in their name or version.</p>
</li>
</ol>
<h3 id="getting-help">Getting help<a class="headerlink" href="#getting-help" title="Permanent link">&para;</a></h3>
<p>One way to get help on a particular module has already been discussed on this
page: <code>module spider &lt;name&gt;/&lt;version&gt;</code> will produce help about the package as
soon as it can unambiguously determine the package. It is the only command that
can produce help for all installed packages. The next two commands can only
produce help about available packages.</p>
<p>A second command is <code>module whatis</code> with the name or name and version of a
module. It will show the brief description of the module that is included in
most modules on the system. If the full version of the module is not given, it
will display the information for the default version of that module.</p>
<p>The third command is <code>module help</code>. Without any further argument it will display
some brief help about the module command. However, when used as 
<code>module help &lt;name&gt;</code> or <code>module help &lt;name&gt;/&lt;version&gt;</code> it will produce help for either the
default version of the package (if the version is not specified) or the
indicated version.</p>
<h3 id="implementation-details_1">Implementation details<a class="headerlink" href="#implementation-details_1" title="Permanent link">&para;</a></h3>
<p>Lmod works by executing the module file. However, the actions of all Lmod-defined 
functions will depend upon the mode in which Lmod is executing the module function,
and the module file can also detect in which mode it is executing.
Modes include "load", "unload"but also "spider".  E.g., when te mode is "load", the
<code>setenv</code> function will set an environment variable to the indicated value while in 
"unload" mode that environment variable will be unset, and in "spider" mode the 
environment variable is left untouched. The working of <code>prepend_path</code>, a function 
that modifies PATH-style variables, depends a bit on how Lmod is configured (as it is
possible to work with reference counts), but in its most basic mode, <code>prepend_path</code>
will add a given directory to a given PATH-style environment variable (or move it to
the front of the PATH-style variable if the directory is already in there), while in
"unload" mode that specific directory will be removed from the PATH (but no error will
be generated should the directory that is used as the argument not be part of the path
in that PATH-style variable). When the mode is "spider", the function has special behaviour
if it is used to change the <code>MODULEPATH</code>. It will then note the change and add that
directory to the list of directories that has to be searched for module files.
This makes <code>module spider</code> a very expensive command as it may have to traverse a lot
of directories and has to execute all module files in there. Therefor Lmod will build
a so-called spider cache which can be pre-built in the system for  certain directories
and otherwise will be build in the user's home directory (in the <code>.lmod.d/.cache</code>
subdirectory). Our experience is that this cache tends to be rather fragile,
in particular on Cray systems (and that has been confirmed in discussions with 
people with access to some other Cray systems) so from time to time Lmod fails to
note changes to the modules, at least when using commands such as <code>module spider</code>.
The actual loading and unloading of the module is not based on cached information.</p>
<p>Lmod has several functions that can be used in module files to provide the information 
that Lmod needs for the search-related and help commands.</p>
<p>The <code>help</code> function defines the long help text used by <code>module help</code> and by
<code>module spider</code> as soon as there is no ambiguity anymore about which module is
being searched for.</p>
<p>The <code>whatis</code> function is used to provide short information about a module. That 
information is then used by <code>module whatis</code> and <code>module keyword</code> , but also
for brief information shown by <code>module spider</code> when multiple modules or versions
of modules are found by the command. A module file can contain multiple <code>whatis</code>
commands and the Lmod manuel suggests to use those lines as a kind of database
record. See, e.g., 
<a href="https://lmod.readthedocs.io/en/latest/100_modulefile_examples.html?highlight=whatis">the Lmod manual page with module file examples</a>.
One such example is
<div class="highlight"><pre><span></span><code><span class="n">whatis</span><span class="p">(</span><span class="s2">&quot;Name:        valgrind&quot;</span><span class="p">)</span>
<span class="n">whatis</span><span class="p">(</span><span class="s2">&quot;Version:     3.7.0&quot;</span><span class="p">)</span>
<span class="n">whatis</span><span class="p">(</span><span class="s2">&quot;Category:    tools&quot;</span><span class="p">)</span>
<span class="n">whatis</span><span class="p">(</span><span class="s2">&quot;URL:         http://www.valgrind.org&quot;</span><span class="p">)</span>
<span class="n">whatis</span><span class="p">(</span><span class="s2">&quot;Description: memory usage tester&quot;</span><span class="p">)</span>
</code></pre></div>
It is not all that important to include all those lines in a module file, but some of
those lines get a special treatment from Lmod. The line starting with <code>Description</code>
is used by <code>module spider</code> to provide some brief information about the module if it
is not totally resolved. This comes with a limitation though: It is not show for each
version of the module, so ideally all "GROMACS" modules should contain the same
description line and use other lines to provide further information about what
distinguished a particular version. 
Likewise the <code>Category:</code> line is used by the <code>spider_decoration</code> hook that can be
used to add decoration to the spider level 1 output.
All in all the <code>whatis</code> function if often overlooked in Lmod-based module functionx
but it is a very useful function to include in the proper way in module files.</p>
<p>A third function that provides information to the search commands is <code>extensions</code>. 
It can be used to list up the extensions supported by the module. The argument list
may seem strange as it takes only a single argument, a string of comma-separated <code>extension/version</code>
elements, but that is because the number of arguments to a function is limited in
Lua and that limit can actually be met easily by modules for Python, Perl or R packages.</p>
<hr />
<h2 id="some-warnings-about-writing-modulefiles">Some warnings about writing modulefiles<a class="headerlink" href="#some-warnings-about-writing-modulefiles" title="Permanent link">&para;</a></h2>
<p><strong><em>This section is very technical and only useful if you want to manually implement
modules that depend on each other one way or another.</em></strong></p>
<p>Lmod cannot guarantee that the order of unloading the modules will be the inverse of
the order in which they were loaded. Moreover, unloading a module is not done by reverting
stored actions done when loading the module, but by executing the modulefile again 
in a mode that reverts certain actions. This can lead to subtle problems when modulefiles
communicate with each other through environment variables or by detecting which other 
modules are loaded. These problems are usually solved by using a proper hierarchy 
and basing actions of modulefiles on their position in the hierarchy.</p>
<p>One case where passing information between modules through environment variables will
go wrong is when that environment variable is subsequently used to compute a directory
name that should be added to a PATH-like variable. Assume we have two versions of
a <code>MyPython</code> module, e.g., <code>MyPython/2.7.18</code> and <code>MyPython/3.6.10</code>. That module then
sets an environment variable <code>PYTHON_API_VERSION</code> to either <code>2.7</code>  or <code>3.6</code>.
Next we have a module <code>MyPythonPackage</code> that makes a number of Python packages available
for both Python modules. However, as some Python packages have to be installed separately
for each Python version, it does so by adding a directory to the environment variable
<code>PYTHON_PATH</code> that contains the version which it gets by using the Lua function
<code>os.getenv</code> to request the value of <code>PYTHON_API_VERSION</code>. </p>
<p>One problem becomes clear in the following scenario:
<div class="highlight"><pre><span></span><code>module load MyPython/2.7.18
module load MyPythonPackage/1.0
module load MyPython/3.6.10
</code></pre></div>
The <code>module load MyPythonPackage</code> will find the environment variable <code>PYTHON_PACKAGE_API</code> 
with the value <code>2.7</code>  as set by <code>module load MyPython/2.7.18</code> and hence add the directory
for the packages for version 2.7 to <code>PYTHON_PATH</code>. The <code>module load MyPython/3.6.10</code> 
command will trigger two operations because of the <em>"one name rule"</em>: First it will 
automatically unload <code>MyPython/2.7.18</code> (which will unset <code>PYTHON_API_VERSIUON</code>) and
next it will load <code>MyPython/3.6.10</code> which will set <code>PYTHON_API_VERSION</code> to <code>3.6</code>. 
However, <code>MyPythonPackage</code> is not reloaded so the <code>PYTHON_PATH</code> variable will now point
to the wrong directory. One would be tempted to think that the easy fix for the user would
be to reload <code>MyPythonPackage/1.0</code>:
<div class="highlight"><pre><span></span><code>module load MyPythonPackage/1.0
</code></pre></div>
Because of the <em>"one name rule"</em> this will again trigger an unload followed by a load
of the module. The problem is in the unload. One would expect that first unloading
<code>MyPythonPackage</code> would remove the 2.7 directory from the <code>PYTHON_PATH</code> but it 
will not. Lmod does not remeber that last time it loaded <code>MyPythonPackage</code> it added
the 2.7 directory to <code>PythonPath</code>. Instead it will execute the commands in the 
modulefile and reverse certain commands. Since <code>PYTHON_API_VERSION</code> has now the value
<code>3.6</code>, it will try to remove the directory for version <code>3.6</code> which is not in the
<code>PYTHON_PATH</code>. The subsequent load will then add the 3.6 directory to <code>PYTHON_PATH</code>
so the environment variable now contains both directories. </p>
<p>In this simple case, a <code>module purge</code> after the first two <code>module load</code> commands would
still work as Lmod is able to figure out the right order to unload modules, but in more
complicated examples this may also go wrong. However, a <code>module purge</code> command after
the load of <code>MyPython/3.6.10</code> would also fail to clean up the environment as it would
still fail to remove the 2.7 directory from <code>PYTHONPATH</code>. </p>
<details class="note">
<summary>Running the example</summary>
<p>To test this example for yourself, create a directory and add that directory to 
the <code>MODULEPATH</code> using <code>module use</code>. In that directory, create the following
subdirectories and files:
1.  <code>MyPython/2.7.18.lua</code> with content:
    <div class="highlight"><pre><span></span><code><span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;In &#39;</span> <span class="o">..</span>  <span class="n">myModuleFullName</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39; in mode &#39;</span>  <span class="o">..</span> <span class="n">mode</span><span class="p">()</span> <span class="p">)</span>
<span class="n">setenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;2.7&#39;</span> <span class="p">)</span>
</code></pre></div>
2.  <code>MyPython/3.6.10.lua</code> with content:
    <div class="highlight"><pre><span></span><code><span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;In &#39;</span> <span class="o">..</span>  <span class="n">myModuleFullName</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39; in mode &#39;</span>  <span class="o">..</span> <span class="n">mode</span><span class="p">()</span> <span class="p">)</span>
<span class="n">setenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;3.6&#39;</span> <span class="p">)</span>
</code></pre></div>
3.  <code>MyPythonPackage/1.0.lua</code> with content:
    <div class="highlight"><pre><span></span><code><span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;In &#39;</span> <span class="o">..</span>  <span class="n">myModuleFullName</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39; in mode &#39;</span>  <span class="o">..</span> <span class="n">mode</span><span class="p">()</span> <span class="p">)</span>
<span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION = &#39;</span> <span class="o">..</span> <span class="p">(</span> <span class="nb">os.getenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">)</span>
<span class="n">prepend_path</span><span class="p">(</span> <span class="s1">&#39;PYTHON_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;someroot/python&#39;</span> <span class="o">..</span> 
  <span class="p">(</span> <span class="nb">os.getenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;TTT&#39;</span> <span class="p">)</span> <span class="o">..</span> <span class="s1">&#39;/packages&#39;</span> <span class="p">)</span>
<span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;PYTHON_PATH = &#39;</span> <span class="o">..</span> <span class="p">(</span> <span class="nb">os.getenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_PATH&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">)</span>
</code></pre></div></p>
</details>
<details class="note">
<summary>Solution with a hierarchy</summary>
<p>The better way in Lmod to implement the above scenario would be in a module hierarchy.</p>
<p>Just to show the power of Lmod introspection functions combined with a proper hierarchy
we present a solution using only one version of the code for <code>MyPython</code> and one version
of the code for <code>MyPythonPackages</code>.</p>
<p>It is best to start from a clean directory. In that directory, create:</p>
<ol>
<li>
<p>The files <code>level1/MyPython/2.7.18.lua</code> and <code>level1/MyPython/3.6.10.lua</code>,
    both with the same contents:
    <div class="highlight"><pre><span></span><code><span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">In &#39;</span> <span class="o">..</span>  <span class="n">myModuleFullName</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39; in mode &#39;</span>  <span class="o">..</span> <span class="n">mode</span><span class="p">()</span> <span class="p">)</span>

<span class="kd">local</span> <span class="n">api_version</span> <span class="o">=</span> <span class="n">myModuleVersion</span><span class="p">():</span><span class="n">match</span><span class="p">(</span> <span class="s1">&#39;(%d+%.%d+)%..*&#39;</span> <span class="p">)</span>

<span class="c1">-- Set the variable PYTHON_API_VERSION but not for internal use in the modules.</span>
<span class="n">setenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION&#39;</span><span class="p">,</span> <span class="n">api_version</span> <span class="p">)</span>

<span class="kd">local</span> <span class="n">module_root</span> <span class="o">=</span> <span class="n">myFileName</span><span class="p">():</span><span class="n">match</span><span class="p">(</span> <span class="s1">&#39;(.*)/level1/&#39;</span> <span class="o">..</span> <span class="n">myModuleFullName</span><span class="p">()</span> <span class="p">)</span>
<span class="n">prepend_path</span><span class="p">(</span> <span class="s1">&#39;MODULEPATH&#39;</span><span class="p">,</span> <span class="n">pathJoin</span><span class="p">(</span> <span class="n">module_root</span><span class="p">,</span> <span class="s1">&#39;level2/PythonAPI&#39;</span><span class="p">,</span> <span class="n">api_version</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;MODULEPATH is now</span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">..</span>
    <span class="nb">os.getenv</span><span class="p">(</span> <span class="s1">&#39;MODULEPATH&#39;</span> <span class="p">):</span><span class="n">gsub</span><span class="p">(</span>  <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="p">)</span> <span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p>The files <code>level2/PythonAPI/2.7/MyPythonPackage/1.0.lua</code> and
    <code>level2/PythonAPI/3.6/MyPythonPackage/1.0.lua</code>, both with the contents:
    <div class="highlight"><pre><span></span><code><span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">In &#39;</span> <span class="o">..</span>  <span class="n">myFileName</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39; in mode &#39;</span>  <span class="o">..</span> <span class="n">mode</span><span class="p">()</span> <span class="p">)</span>

<span class="kd">local</span> <span class="n">python_api_version</span> <span class="o">=</span> <span class="n">myFileName</span><span class="p">():</span><span class="n">match</span><span class="p">(</span> <span class="s1">&#39;.*/level2/PythonAPI/([^/]+)/.*&#39;</span> <span class="p">)</span>
<span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;Detected Python API version from hierarchy: &#39;</span> <span class="o">..</span> <span class="n">python_api_version</span> <span class="p">)</span>
<span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;Detected Python API version from environment: &#39;</span> <span class="o">..</span>
    <span class="p">(</span> <span class="nb">os.getenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_API_VERSION&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">)</span>

<span class="n">prepend_path</span><span class="p">(</span> <span class="s1">&#39;PYTHON_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;someroot/python&#39;</span> <span class="o">..</span> <span class="n">python_api_version</span> <span class="o">..</span> <span class="s1">&#39;/packages&#39;</span> <span class="p">)</span>

<span class="n">LmodMessage</span><span class="p">(</span> <span class="s1">&#39;PYTHON_PATH = &#39;</span> <span class="o">..</span> <span class="p">(</span><span class="nb">os.getenv</span><span class="p">(</span> <span class="s1">&#39;PYTHON_PATH&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">)</span>
</code></pre></div></p>
</li>
</ol>
<p>Now add the <code>level1</code> subdirectory to <code>MODULEPATH</code>, e.g., if you're in the directory
containing the <code>level1</code> and <code>level2</code> subdirectories:
<div class="highlight"><pre><span></span><code>module use <span class="nv">$PWD</span>/level1
</code></pre></div>
and then try the following commands:
<div class="highlight"><pre><span></span><code>module avail
module load MyPython/2.7.18
module avail
module load MyPythonPackage/1.0
module load MyPython/3.6.10
</code></pre></div>
and pay attention to the output.</p>
<p>Initially <code>module avail</code> will show none of the <code>MyPythonPackage</code> modules. These are
installed modules but not available modules. <code>module load MyPython/2.7.18</code> will set the
environment variable <code>PYTHON_API_VERSION</code> to <code>2.7</code> and also add a directory to the front
of the <code>MODULEPATH</code> with the directory name ending on <code>level2/PythonAPI/2.7</code>. Now
<code>module avail</code> will show the <code>MyPythonPackage/1.0</code> module.</p>
<p>The <code>MyPythonPackage</code> shows two ways to get the version of the Python API to use for
determining the right directory to add to <code>PYTHON_PATH</code>. The fragile way is to enquire
the value of the environment variable <code>PYTHON_API_VERSION</code> set by loading <code>MyPython/2.7.18</code>.
The more robust way is to use the Lmod introspection function <code>myFileName()</code> which returns
the full path and file name of the module file that is executing, and extracting the version
from the path with a pattern matching function. In this particular situation both computed
values are the same so both would have worked to correctly add
<code>somedir/python2.7/packages</code> to the front of <code>PYTHON_PATH</code>. </p>
<p>The next command, <code>module load MyPython/3.6.10</code> triggers a chain of events.</p>
<p>First, Lmod notices that there is already a module loaded with the same name, so it will
unload <code>MyPython/2.7.18</code>. This will unset the environment variable <code>PYTHON_API_VERSION</code>
(the inverse operation of <code>setenv</code>) and will remove the <code>.../level2/PythonAPI/2.7</code>
subdirectory from the <code>MODULEPATH</code> (the inverse action of <code>prepend_path</code>). </p>
<p>Now due to 
the change of the <code>MODULEPATH</code> the <code>MyPythonPackage/1.0</code> module which was loaded from
<code>.../level2/PythonAPI/2.7</code> is no longer available so Lmod will continue with unloading
that module. The interesting bit now is that <code>PYTHON_API_VERSION</code> is unset. So had we 
computed the name of the directory to add to <code>PYTHON_PATH</code> using the value of that 
environment variable, the module would have failed to compute the correct directory name
to remove so <code>prepend_path</code> would have left the <code>PYTHON_PATH</code> environment variable
untouched. However, by computing that value from the directory of the modulefile, we get
the right value and can correctly remove <code>somedir/python2.7/packages</code> from <code>PYTHON_PATH</code>.
Lmod will also remember that the module was only unloaded due to a change in the
<code>MODULEPATH</code> and not because a user explicitly unloaded the module. I.e., it considers
the module as deactivated but not as unloaded.</p>
<p>Lmod proceeds with loading the <code>MyPython/3.6.10</code> module. This will now set
<code>PTHON_API_VERSION</code> to <code>3.6</code> and add a directory with name ending on
<code>level2/PythonAPI/3.6</code> to <code>MODULEPATH</code>.</p>
<p>Things are not done yet though. As the <code>MODULEPATH</code> has changed, Lmod looks at its list
of deactivated modules and notices that a different version of <code>MyPythonPackage/1.0</code> is
now available. Hence it will now automatically load that module from the 
<code>.../level2/PythonAPI/3.6</code> subdirectory so that that module now correctly detects
that <code>somedir/python3.6/package</code> should be added to <code>PYTHON_PATH</code>.</p>
<p>Hence at the end of the cycle we have again a correctly configured environment with no
trace of the <code>2.7</code> version that was loaded initially and with no action required from
the user to ensure that <code>MyPythonPackage</code> is unloaded and reloaded to ensure the 
correct configuration.</p>
<p>This idea is used on LUMI to implement the various versions of the software stack with
for each software stack also optimised binaries for each of the node types.</p>
</details>
<hr />
<h2 id="further-reading">Further reading<a class="headerlink" href="#further-reading" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://lmod.readthedocs.io/en/latest/index.html">Lmod documentation</a></li>
<li><a href="https://docs.lumi-supercomputer.eu/computing/Lmod_modules/">Lmod on LUMI in the LUMI documentation</a></li>
<li><a href="https://modules.readthedocs.io/en/latest/">Documentation of Environment Modules 5</a>,
    an alternative to Lmod (though not currently supported by HPE Cray)</li>
</ul>
<hr />
<p><em><a href="../1_03_CPE/">[next: The Cray Programming Environment]</a></em></p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 7, 2022</span>
      
    
  </small>
</div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../1_01_what_is_easybuild/" class="md-footer__link md-footer__link--prev" aria-label="Previous: What is EasyBuild?" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              What is EasyBuild?
            </div>
          </div>
        </a>
      
      
        
        <a href="../1_03_CPE/" class="md-footer__link md-footer__link--next" aria-label="Next: The HPE Cray Programming Environment" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              The HPE Cray Programming Environment
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/easy_build" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.youtube.com/c/easybuilders" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://easybuild.readthedocs.io" target="_blank" rel="noopener" title="easybuild.readthedocs.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M448 336V48c0-26.51-21.5-48-48-48H96C42.98 0 0 42.98 0 96v320c0 53.02 42.98 96 96 96h320c17.67 0 32-14.33 32-31.1 0-11.72-6.607-21.52-16-27.1v-81.36c9.8-9.64 16-22.24 16-36.44zM143.1 128h192c9.7 0 16.9 7.2 16.9 16s-7.2 16-16 16H143.1c-7.9 0-15.1-7.2-15.1-16s7.2-16 15.1-16zm0 64h192c9.7 0 16.9 7.2 16.9 16s-7.2 16-16 16H143.1c-7.9 0-15.1-7.2-15.1-16s7.2-16 15.1-16zM384 448H96c-17.67 0-32-14.33-32-32s14.33-32 32-32h288v64z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["instant", "navigation.top", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>